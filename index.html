<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="stylesheet.css"/>
<script type="text/javascript" src="split.js"></script>
<script type="text/javascript" src="redact.js"></script>
</head>
<script language="javascript">

var winner = false;
var reveal = false;
var textArr = [];   // an array of "words" (words, markup or punctuation)
var highlight = ""; // TODO highlight all instances of this word
var guessedWords = [];
var guessedHits = [];   // TODO parallel arrays = not good
var reservedWords = [
    // free guesses
    'a', 'and', 'in', 'be', 'are', 'so', 'the', 'this', 'that', 'then',
    // also all the expected html tags
    '<p>', '</p>',
    '<h1>', '</h1>',
    '<h2>', '</h2>',
    '<h3>', '</h3>',
    '<i>', '</i>',
    '<br/>',
    '<blockquote>', '</blockquote>',
    // entities for later TODO
    '&ldquo;', '&rdquo;',
    '&lsquo;', '&rsquo;',
    '&mdash;'
]

function init() {
    textArr = split(text);      // splits text (defined in game/*js) into textarray
    rText = redactText();       // redacts the entire array
    displayText(rText);         // writes text panel
    updateGuesses();            // writes guess panel
}

function displayText(rText) {
    out = []
    out.push("<h3>Bookish " + game + "</h3>");
    if (winner) {
        var h = 0;
        var m = 0;
        for (var i = 0 ; i < guessedHits.length ; i++) {
            if (guessedHits[i] == 0) {
                m++;
            } else {
                h++;
            }
        }
        var pc = h * 100 / (h + m);
        out.push("<h1>YOU ARE A WINNER</h1>"
            + "<h2>Total Guesses: " + (h + m) + "</h2>"
            + "<h2>Total Hits: " + h + "</h2>"
            + "<h2>Total Misses: " + m + "</h2>"
            + "<h2>Percentage correct: " + Math.floor(pc) + "</h2>"
        );
    }
    if (reveal) {
        // add a link to the original
        out.push("<h2>Read the whole thing at</h2>"
            + "<h2><a href='" + url + "'>Project Gutenberg</a></h2>"
            + "<br/>"
        );
    }
    out.push(rText);
    d = document.getElementById('textPane');
    d.innerHTML = out.join('');
}

function updateGuesses() {
    var gText = ["<h2 class='guessTitle'>Guesses</h2>"];
    //debug("Guesses " + guessedWords + ", " + guessedWords.length);
    gText.push("<table id='guessList'>");
    gText.push("<tr>");
    gText.push("<td class='count'>#</td>");
    gText.push("<td class='guess'>Guess</td>");
    gText.push("<td class='hits'>Hits</td>");
    gText.push("</tr>");
    for (var i = guessedWords.length - 1 ; i >= 0 ; i--) {
        var word = guessedWords[i];
        //debug("Word[" + i + "] " + word);
        gText.push("<tr id='guess" + i + "' onclick='return hiWord(" + i + ")'>");
        gText.push("<td class='count'>" + (i + 1) + ":</td>");
        gText.push("<td class='guess'>" + word + "</td>");
        gText.push("<td class='hits'>" + guessedHits[i] + "</td>");
        gText.push("</tr>");
    }
    gText.push("</table>");
    //debug("gtext " + gText);
    d = document.getElementById('guessesPane');
    d.innerHTML = gText.join('');
}

// highlights the word
// (either the just entered word or the one just clicked in guesslist)
var hi = 0;
function hiWord(index) {
    var highs = guessedHits[index]; // hits for this chosen word
    if (highs == 0) {
        // nothing to highlight for this word
        return;
    }
    if (guessedWords[index] != highlight) {
        // first press - need to refresh
        hi = 0;
        highlight = guessedWords[index];
        rText = redactText();   // this will update hits and return redacted text array
        displayText(rText);     // show the text
        updateGuesses();        // show the guesses
    }
    ele = document.getElementById('hi' + hi);
    // TODO highlight this one specifically? invert?
    ele.scrollIntoView({
        behavior: 'auto',
        block: 'center',
        inline: 'center'
    });
    // next time...
    hi = (hi + 1) % highs;
}

function guessWord(event) {
    // button sends null, keypress sends keycode of input
    if (event != null && event.keyCode != 13) {
        // ignore keys that aren't enter
        return;
    }
    var d = document.getElementById("inputword");
    word = d.value.toLowerCase();
    if (word == "") {
        return;
    }
    // clear box
    d.value = '';
    //debug("WORD " + word);
    if (!reservedWords.includes(word) && !guessedWords.includes(word)) {
        guessedWords.push(word);
        if (title.includes(word)) {
            // remove word from title array
            var tmp = [];
            for (var i = 0 ; i < title.length ; i++) {
                if (title[i] != word) {
                    tmp.push(title[i]);
                }
            }
            title = tmp;
            //debug("Title " + title);
        }
        if (title.length == 0) {
            reveal = true;
            winner = true;
        }
        // highlight is the current guess
        highlight = word;
        hits = 0;
        rText = redactText();   // this will update hits and return redacted text array
        //debug("Guess: Word " + word + " Hits " + hits);
        guessedHits.push(hits);
        displayText(rText);     // show the text
        updateGuesses();        // show the guesses
        hi = 0;
        hiWord(guessedWords.length - 1);    // highlight the new word
    }
}

function gotoTop() {
    document.getElementById('textPane').scrollTop = 0;
}
</script>
<body>
<div id="left">
    <div id="textPane">The text goes here</div>
    <div id="inputPane">
        <div style="text-align: center">
            <input type="button" value="Top" onclick="return gotoTop()"/>
            <input type="text" id="inputword" size="20"
                onclick="document.getElementById('inputword').value = ''"
                onkeypress="return guessWord(event)"
                placeholder="Guess"/>
            <input type="button" value="Guess" onclick="return guessWord(null)"/>
        </div>
    </div>
</div>
<div id="right">
  <div id="guessesPane">The guesses go here</div>
</div>
<script>
// load the relevant game
var game = document.location.search.substring(1);
// get dateStr for current date
var date = new Date();
var yyyy = "" + date.getUTCFullYear();
var mm = date.getUTCMonth() + 1;
if (mm < 10) {
    mm = "0" + mm;
};
var dd = date.getUTCDate();
if (dd < 10) {
    dd = "0" + dd
}
var dateStr = "" + yyyy + mm + dd;
//debug("Game: " + game + " Date: " + dateStr)
// if game not given or it's the future then use today
if (game == "" || game > dateStr) {
    game = dateStr;
}
//debug("Game " + game);
document.write('<script language="javascript" src="games/' + game + '.js"><\/script>');
</script>
<!-- and initialise it -->
<script>
init();
</script>
</body>
</html>
